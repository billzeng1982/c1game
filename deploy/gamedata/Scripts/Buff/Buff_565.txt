--[[
名称：机关神兽――伤血
类型：武将技能Buff
描述：AOE伤害
--]]
local ThisScriptId = 565;

--Buff诞生处理
local function runBorn(LuaDataAgt)
	-- 设置Buff公式
	LuaDataAgt:SetBuffLifeTime(VALUE_TYPE.CURRENT,2);
	local rSource = LuaDataAgt:GetBuffSource();
	--找之前先清空一次
	LuaDataAgt:ClearTarget();
	local targetList = LuaDataAgt:FindTarget(TARGET_GROUP.SELF);
	--剔除死亡或回城部队，targetList也会随之改变
	LuaDataAgt:RemoveTroopDeadOrRetreat(targetList);
	--剔除不可见
	LuaDataAgt:RemoveTroopInVisible(targetList);
	if targetList.Count > 0 then
		local vCurPosX;
		local vCurPosZ;
		local randomValue = math.random(0, targetList.Count - 1);
	    local target = targetList:get_Item(randomValue);--找到任意一个敌方目标
		vPos = target:GetCurPos();
		vCurPosX = vPos.x;
		vCurPosZ = vPos.z;
		local vTargetPos = Vector3(vCurPosX, 0.0, vCurPosZ);
		--特效和伤害生效调节
		LuaDataAgt:SetShareValue(0,vCurPosX);
		LuaDataAgt:SetShareValue(1,vCurPosZ);
		LuaDataAgt:SetShareTimer(1,1.75);
		--print("X1="..vCurPosX);
		--print("Z1="..vCurPosZ);
		LuaDataAgt:PlayFX("Prefabs/BuffEffect/Buff_Jgss_End", nil, vTargetPos, vTargetPos, 0, true); -- 延迟0播该特效
	end
	--特效和伤害生效调节
end

--Buff驱散条件判断
local function checkDeadCond(LuaDataAgt)
	return false;
end

--Buff驱散生效
local function runDead(LuaDataAgt)
	if not IsOnServer then
		LuaDataAgt:RefreshFightNum();
	print("runDead end");
	end
end

--Buff生效条件判断
local function checkEffectCond(LuaDataAgt)
	return true;
end

--找对象，上面条件满足后执行
local function findTarget(LuaDataAgt)
	
end

--Buff生效
local function takeEffect(LuaDataAgt)
	
	local iTime = LuaDataAgt:GetShareTimer(1);
	--特效没到爆炸时间
	if iTime > 0 then
		return 
	end

	local rSource = LuaDataAgt:GetBuffSource();
	local vCurPosX = LuaDataAgt:GetShareValue(0);
	local vCurPosZ = LuaDataAgt:GetShareValue(1);
	print("X2="..vCurPosX);
	print("Z2="..vCurPosZ);
	LuaDataAgt:ClearTarget();
	local targetList1 = LuaDataAgt:FindTargetEx(TARGET_GROUP.SELF, SHAPE_TYPE.CIRCLE, vCurPosX, vCurPosZ, 20, 1);
	--剔除死亡或回城部队，targetList也会随之改变
	LuaDataAgt:RemoveTroopDeadOrRetreat(targetList1);
	local num = targetList1.Count;
	print("targetList1="..num);
	local dancePower = LuaDataAgt:GetActiveSkillShareValue(0);
	for i=0,targetList1.Count-1 do
		--添加Buff，扣血
		local target = targetList1:get_Item(i);
		--target:AddBuff(566, LuaDataAgt, nil);
		target:ChgHp(VALUE_TYPE.CURRENT, dancePower, rSource ,VALUE_CHG_TYPE.CHG_HP_GENERALSKILL, 9, 0);
	end

	LuaDataAgt:SetShareTimer(1,2);
end


Buff_565 = {
	func_runBorn = runBorn;
	func_checkDeadCond = checkDeadCond;
	func_findTarget = findTarget;
	func_runDead = runDead;
	func_checkEffectCond = checkEffectCond;
	func_takeEffect = takeEffect;
}