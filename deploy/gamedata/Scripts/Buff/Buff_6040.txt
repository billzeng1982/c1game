--[[
名称:火焰印记
类型:被动技能
描述:活体炸弹,持续伤害
--]]
local ThisScriptId = 6040;


--Buff诞生处理
local function runBorn(LuaDataAgt)
	LuaDataAgt:SetBuffLifeTime(VALUE_TYPE.RUNTIME_CONF, 5);
	

	--设置过滤器
	LuaDataAgt:SetFilter(FILTER_TYPE.HP, TARGET_GROUP.NONE, -2);
	
	LuaDataAgt:SetFormula(VALUE_CHG_TYPE.CHG_HP_BUFF, ThisScriptId, 0);
	--LuaDataAgt:SetFilter(FILTER_TYPE.POS, TARGET_GROUP.NONE, -2);
	if not IsOnServer then
		local TarPos = LuaDataAgt:GetCurPos();
		LuaDataAgt:PlayFX("Prefabs/BasicEffect/3D_CharEff_DianRan", LuaDataAgt, TarPos, TarPos, 0, true);
	end
end

local function findTarget(LuaDataAgt)
	
 end

--Buff驱散条件判断
 local function checkDeadCond(LuaDataAgt)

	return false;
end

--Buff驱散生效
local function runDead(LuaDataAgt)

	print("findTarget");
	--找之前先清一次
	LuaDataAgt:ClearTarget();
	local targetList = LuaDataAgt:FindTargetEx(TARGET_GROUP.SELF, SHAPE_TYPE.CIRCLE, 0, 0, 12.5, 0);
	--local targetList = LuaDataAgt:FindTarget(TARGET_GROUP.SELF);
	--剔除死亡或回城部队，targetList也会随之改变
	--LuaDataAgt:RemoveTroopDeadOrRetreat(targetList);
	print("findTarget successfull");
	
	--targetList = LuaDataAgt:GetTargetList(TARGET_GROUP.SELF);
	
	print("list"..targetList.Count);
	
	for i=0,targetList.Count-1 do
		--print("gettarget");
		--添加Buff，扣血
		local target = targetList:get_Item(i);
		
		--LuaDataAgt:ChgHp(VALUE_TYPE.CURRENT, 0, LuaDataAgt:GetBuffSource(), VALUE_CHG_TYPE.CHG_HP_PASSIVESKILL, ThisScriptId, 0);
		target:AddBuff(563, LuaDataAgt:GetBuffSource(), nil);

		--print("boom!!!");
		local TarPos = LuaDataAgt:GetCurPos();
		LuaDataAgt:PlayFX("Prefabs/SkillEffect/Skill_Hyyj_End", LuaDataAgt, TarPos, TarPos, 0, true); -- 延迟0播该特效
	end
	LuaDataAgt:InterruptSiege();
	if not IsOnServer then
		LuaDataAgt:RefreshFightNum();
	end
end

 --Buff生效条件判断
local function checkEffectCond(LuaDataAgt)
	return true;
end

-- Buff生效
local function takeEffect(LuaDataAgt)
	print("effect");
	local btime = LuaDataAgt:GetBuffLifeTime(VALUE_TYPE.CURRENT);
	local rsource = LuaDataAgt:GetBuffSource();
	print("btime"..btime);
	if not LuaDataAgt:IsDead() and	LuaDataAgt:GetBuffLifeTime(VALUE_TYPE.CURRENT) > 0  then
	print("if");
		LuaDataAgt:ChgHp(VALUE_TYPE.CURRENT, 0, rsource, VALUE_CHG_TYPE.CHG_HP_BUFF, ThisScriptId, 0);
	end
end

--Buff过滤处理
local function doFilter(LuaDataAgt, iFilterType, rFilterOwner, FilterValue)
	print("Buff filter");
	local IsSource = rFilterOwner:Equal(FilterValue:GetSource());
	if iFilterType == FILTER_TYPE.HP and LuaDataAgt:HasBuff(ThisScriptId) then
		local iHp = FilterValue.m_fFoo1;
		local targetHp = LuaDataAgt:GetHp(VALUE_TYPE.CURRENT);
		if not IsSource and iHp < 0 then 
			if not IsOnServer and (targetHp + iHp) <= 0 and not LuaDataAgt:HasBuff(563) then
				FilterValue.m_fFoo1 = -targetHp + 1;
				print("dead");
				LuaDataAgt:ClearTarget();
				local targetList = LuaDataAgt:FindTargetEx(TARGET_GROUP.SELF, SHAPE_TYPE.CIRCLE, 0, 0, 12.5, 0);
				--LuaDataAgt:RemoveTroopDeadOrRetreat(targetList);
				--剔除死亡或回城部队，targetList也会随之改变
				--targetList = LuaDataAgt:GetTargetList(TARGET_GROUP.SELF);
				for i=0 , targetList.Count-1 do
					--扣血
					local target = targetList:get_Item(i);
						
					target:AddBuff(563, LuaDataAgt:GetBuffSource(), nil);
					print("boom!!!");
					local TarPos = LuaDataAgt:GetCurPos();
					LuaDataAgt:PlayFX("Prefabs/SkillEffect/Skill_Hyyj_End", LuaDataAgt, TarPos, TarPos, 0, true); -- 延迟0播该特效
				end
				LuaDataAgt:InterruptSiege();
			end
		end
	end
	return FilterValue;
end

--Buff公式处理
local function doFormula(LuaDataAgt, iFormulaType, iFormulaPara, rSource, rTarget, iDamageRef)
	local WitAtk = rSource:GetWitAtk(VALUE_TYPE.CURRENT);
	local WitDef = rTarget:GetWitDef(VALUE_TYPE.CURRENT);
	local BaseDamage = rSource:GetPassiveSkillBaseValue(ThisScriptId, 1);
	iRet = BaseDamage - WitDef;
	iRet = math.max (iRet,70);
	print("dot damage");
	return -iRet;
end


Buff_6040 = {
	func_runBorn = runBorn;
	func_findTarget = findTarget;
	func_checkDeadCond = checkDeadCond;
	func_runDead = runDead;
	func_checkEffectCond = checkEffectCond;
	func_takeEffect = takeEffect;
	func_doFilter = doFilter;
	func_doFormula = doFormula;
}