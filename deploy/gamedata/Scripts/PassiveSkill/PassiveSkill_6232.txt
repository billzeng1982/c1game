--[[
名称：小乔被动4
类型：被动技能
描述：小乔有概率反弹伤害给敌军，且本次攻击小乔不受伤害，如果周瑜在队伍中，则概率提高10%
--]]
local ThisScriptId = 6232;

--技能诞生处理
local function runBorn(LuaDataAgt)
	-- 添加血量过滤处理
	LuaDataAgt:SetFilter(FILTER_TYPE.HP, TARGET_GROUP.NONE, 0);
	
	print("RunBorn PassiveSkill Id = "..ThisScriptId);
end

--技能条件判断
local function checkCond(LuaDataAgt)
	return true;
end

--找对象，上面条件满足后执行
local function findTarget(LuaDataAgt)
end

--技能生效，数值处理
local function takeEffect(LuaDataAgt)
	if IsOnServer then
		LuaDataAgt:SetSkillEnable(false);
		return;
	end
	
	-- 一场战斗中只生效一次
	LuaDataAgt:SetSkillEnable(false);
end

--Skill过滤处理
local function doFilter(LuaDataAgt, iFilterType, rFilterOwner, FilterValue)
	-- Filter所有者是否是发起对象
	local IsSource = rFilterOwner:Equal(FilterValue:GetSource());
	local Ratio = LuaDataAgt:GetPassiveSkillBaseValue(ThisScriptId, 2)/100;
	print("Ratio="..Ratio);
	if iFilterType == FILTER_TYPE.HP then
		local iHp = FilterValue.m_fFoo1;
		iHp = iHp * Ratio;
		if  iHp < 0 and not IsSource then
			local Chance = LuaDataAgt:GetPassiveSkillBaseValue(ThisScriptId, 1) * 100;
			local targetGeneral = LuaDataAgt: GetTargetTroopByGeneralId(TARGET_GROUP.SELF, 3);
			if targetGeneral ~= nil then
				Chance = Chance + 1000;
			end
			
			math.randomseed(tostring(os.time()):reverse():sub(1, 6)) ;
			local j = math.random(1,10000);
			--Chance = 10000 ; 
			if j < Chance then
				FilterValue.m_fFoo1 = 0 --免伤
				local Source = FilterValue:GetSource();
				local MaxDamage1 = 5 * LuaDataAgt:GetWitAtk(VALUE_TYPE.CURRENT);
				local MaxDamage2 = Source:GetHp(VALUE_TYPE.ORIGIN_CONF);

				iHp = math.min(iHp,MaxDamage1);
				iHp = math.min(iHp,MaxDamage2);
				Source:ChgHp(VALUE_TYPE.CURRENT, iHp, LuaDataAgt, VALUE_CHG_TYPE.CHG_HP_COMM, 0, 0);
				if not IsOnServer then
					local CurrPos = LuaDataAgt:GetCurPos();
					--LuaDataAgt:Play2DFXFollowTroopInfo("Prefabs/BasicEffect/UI_CharEff_ShangHaiFanTan", 0 , CurrPos); -- 延迟0播该特效
					LuaDataAgt:PlayFX("Prefabs/BasicEffect/3D_CharEff_ShangHaiFanTan", LuaDataAgt, CurrPos, CurrPos, 0, true);
					local TargetPos = Source:GetCurPos();
					Source:PlayFX("Prefabs/BasicEffect/NormalAtkFx", nil, TargetPos, TargetPos, 0, true);
				end
			end
		end
	end
	
	return FilterValue;
end

PassiveSkill_6232 = {
	func_runBorn = runBorn;
	func_checkCond = checkCond;
	func_findTarget = findTarget;
	func_takeEffect = takeEffect;
	
	func_doFilter = doFilter;
}
