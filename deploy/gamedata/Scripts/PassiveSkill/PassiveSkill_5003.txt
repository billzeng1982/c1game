--[[
名称：枪兵蓄力
类型：兵种技被动
描述：枪兵蓄力
--]]
--5000 + 武将ID*10 + 0~9 : ID 命名规则
--这个ID要和脚本ID保持一致
local ThisScriptId = 5003;

--技能诞生处理
local function runBorn(LuaDataAgt)
	--属性加减
	--使能枪头
	LuaDataAgt:SetFilter(FILTER_TYPE.HP, TARGET_GROUP.NONE, 0);
	LuaDataAgt:SetShareValue(0,0);

end

--技能条件判断
local function checkCond(LuaDataAgt)
	return true;
end

--找对象，上面条件满足后执行
local function findTarget(LuaDataAgt)

end

--技能生效，数值处理
local function takeEffect(LuaDataAgt)
	if IsOnServer then
		LuaDataAgt:SetSkillEnable(false);
		return;
	end

	LuaDataAgt:SetSkillEnable(false);
end

--技能过滤
local function doFilter(LuaDataAgt, iFilterType, rFilterOwner, FilterValue)
	-- Filter所有者是否是发起对象
	local IsSource = rFilterOwner:Equal(FilterValue:GetSource());
	local armyPhase = LuaDataAgt:GetArmyPhase();
	local RageNeed = 5;
	if armyPhase >= 2 then
		RageNeed = 5;
	end
	if iFilterType == FILTER_TYPE.HP then
		--每次加上buff时，计数+1
		if not IsOnServer and IsSource and FilterValue.m_fFoo1 < 0 and (not LuaDataAgt:HasBuff(601)) then
			local SpearTimes = LuaDataAgt:GetShareValue(0);
			if FilterValue.m_iValueChgType == VALUE_CHG_TYPE.CHG_HP_ATK_NORMAL then
				SpearTimes = SpearTimes + 1;
			elseif FilterValue.m_iValueChgType == VALUE_CHG_TYPE.CHG_HP_ATK_SPEAR then
				SpearTimes = SpearTimes + 1;
			elseif FilterValue.m_iValueChgType == VALUE_CHG_TYPE.CHG_HP_ATK_FACE then
				SpearTimes = SpearTimes + 2;
			end
			
			
			
			if SpearTimes >= RageNeed then
				-- 蓄力结束，进入使用阶段
				SpearTimes = 0;
				-- 蓄力进度设置
				LuaDataAgt:SetShareValue(0, SpearTimes);
				LuaDataAgt:SetSpearProgress(SpearTimes > 0, SpearTimes / RageNeed, 0);
				
				LuaDataAgt:AddBuff(601, LuaDataAgt, nil);
			else
				-- 蓄力进度设置
				LuaDataAgt:SetShareValue(0, SpearTimes);
				LuaDataAgt:SetSpearProgress(SpearTimes > 0, SpearTimes / RageNeed, 0);
			end
		end
	end
	return FilterValue;
end

--这个ID要和脚本ID保持一致
PassiveSkill_5003 = {
	func_runBorn = runBorn;
	func_checkCond = checkCond;
	func_findTarget = findTarget;
	func_takeEffect = takeEffect;


	func_doFilter = doFilter;
}