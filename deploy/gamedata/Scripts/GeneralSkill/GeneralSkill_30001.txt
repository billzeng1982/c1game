--[[
名称：喝断黄河
类型：主动技能
描述：张飞爆发出一声怒喝，对周围敌军造成物理伤害，从远到近分别造成1/2/3倍伤害
--]]
local ThisScriptId = 30001;

--技能诞生处理
local function runBorn(LuaDataAgt)
	-- 设置公式
	LuaDataAgt:SetFormula(VALUE_CHG_TYPE.CHG_HP_GENERALSKILL, ThisScriptId, 0);
	LuaDataAgt:SetFormula(VALUE_CHG_TYPE.CHG_HP_SKILLCHEATS, ThisScriptId, 0);
end

--技能条件判断
local function checkCond(LuaDataAgt, AIId)
	--找之前先清一次
	LuaDataAgt:ClearTarget();
	local targetList;
	targetList = LuaDataAgt:FindTargetEx(TARGET_GROUP.ENEMY, SHAPE_TYPE.CIRCLE, 0, 0, 2500, 0);
    LuaDataAgt:MapDrawCircle(0,2500);
	--剔除死亡或回城部队，targetList也会随之改变
	LuaDataAgt:RemoveTroopDeadOrRetreat(targetList);		 
	-- 剔除不可见部队
	LuaDataAgt:RemoveTroopInVisible(targetList);
	
	--圆形判断框
	
	LuaDataAgt:SetMapSkillTarget(TARGET_GROUP.ENEMY);
	
	return true;
end

--找对象，上面条件满足后执行
local function findTarget(LuaDataAgt)
	--找之前先清一次
	LuaDataAgt:ClearTarget();
	local targetList;
	targetList = LuaDataAgt:FindTargetEx(TARGET_GROUP.ENEMY, SHAPE_TYPE.CIRCLE, 0, 0, 2500, 0);
	--剔除死亡或回城部队，targetList也会随之改变
	LuaDataAgt:RemoveTroopDeadOrRetreat(targetList);

	
end

--技能生效，数值处理
local function takeEffect(LuaDataAgt)
	local targetList = LuaDataAgt:GetTargetList(TARGET_GROUP.ENEMY);
	local SourcePos = LuaDataAgt:GetCurPos();

	for i = 0,targetList.Count-1 do
	    --距离越近伤害越高
		local TargetPos = targetList:get_Item(i):GetCurPos();
		local Distance = math.sqrt(((SourcePos.x  -  TargetPos.x) * (SourcePos.x  -  TargetPos.x)) + ((SourcePos.z  -  TargetPos.z) * (SourcePos.z  -  TargetPos.z)));
		targetList:get_Item(i):ChgHp(VALUE_TYPE.CURRENT, Distance, LuaDataAgt,VALUE_CHG_TYPE.CHG_HP_GENERALSKILL, ThisScriptId, 0);
		--添加敌方减防的buff
		targetList:get_Item(i):AddBuff(ThisScriptId, LuaDataAgt, targetList);
	end
end

--技能公式
local function doFormula(LuaDataAgt, iFormulaType, iFormulaPara, rSource, rTarget, iDamageRef)
	local iRet = iDamageRef;
	
	if iFormulaType == VALUE_CHG_TYPE.CHG_HP_SKILLCHEATS then     --秘籍2：吸血，直接返回，防止死循环
	    return iRet;
	end
	
    local DistanceRatio = math.min(math.max((4 - ((iRet - 10) / 3)), 1), 3);
	if LuaDataAgt:IsHaveActiveSkillCheats(2)  then      --秘籍2：最高伤害提高到3.5倍
	    DistanceRatio = math.min(math.max((4 - ((iRet - 10) / 3)), 1), 3.5);
	end
	print("DistanceRatio .."..DistanceRatio);
	local StrAtk = rSource:GetStrAtk(VALUE_TYPE.CURRENT);
	local StrDef = rTarget:GetStrDef(VALUE_TYPE.CURRENT);
	local Base = rSource:GetActiveSkillBaseValue(1);
	local MinDmg = Base;
	local Ratio = rSource:GetActiveSkillRateValue(1);
	iRet = (Base + (StrAtk - StrDef) * Ratio) * DistanceRatio;
	iRet = math.max(iRet,MinDmg);
	
	if LuaDataAgt:IsHaveActiveSkillCheats(1) then    --秘籍1：吸血
	    local addBlood = iRet * 0.1;
		print("add .."..addBlood);
		if addBlood > 0 then
		    LuaDataAgt:ChgHp(VALUE_TYPE.CURRENT, addBlood, LuaDataAgt, VALUE_CHG_TYPE.CHG_HP_SKILLCHEATS, ThisScriptId, 0);
		end
	end
	
	return -iRet;

end


GeneralSkill_30001 = {
	func_runBorn = runBorn;
	func_checkCond = checkCond;
	func_findTarget = findTarget;
	func_takeEffect = takeEffect;
		
	func_doFormula = doFormula;
}